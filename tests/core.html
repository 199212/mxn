<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title>Mapstraction V3 Core Tests</title>
	<script type="text/javascript" src="mxn-harness.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script src="http://api.maps.nokia.com/2.2.3/jsl.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
	</script>
	<link rel="stylesheet" type="text/css" media="all" href="css/core.css" />
	<meta http-equiv="X-UA-Compatible" content="IE=7; IE=EmulateIE9" />
		
	<script type="text/javascript">
	//<![CDATA[
	nokia.Settings.set ("appId", "FbgYuugcrj8Taq6JjmUK");
	nokia.Settings.set ("authenticationToken", "Yy2i2n98kaWj69qysOmcYg");

	var supportedProviders = [
		'esriv3',
		'herev2',
		'googlev3',
		'leafletv0',
		'mapquestv7',
		'microsoftv7',
		'openlayersv2',
		'openmapquestv2',
		'openspacev4',
		'yandexv1',
		'yandexv2'
	];
	
	var provider;
	var autoRun = 'false';

	(function() {
		var providerMatch = location.search.match( /provider=([^&]*)/ );
		var autorunMatch = location.search.match( /auto=([^&]*)/ );

		if (providerMatch) {
			provider = providerMatch[1];
		}
		
		else {
			provider = 'googlev3';
		}

		if (autorunMatch) {
			autoRun = autorunMatch[1];
			if (autoRun !== 'true') {
				autoRun = 'false';
			}
		}
		
		switch (provider) {
			case 'nokia':
				new_provider = 'googlev3';
				break;
			default:
				new_provider = 'nokia';
				break;
		}

		switch ( provider ) {
			case 'esriv3':
				document.write ('<link href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/css/esri.css" media="all" rel="stylesheet" type="text/css" \/>');
				document.write ('<link href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dijit/themes/claro/claro.css" media="all" rel="stylesheet" type="text/css" \/>');
				document.write ('<script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.5" type="text/javascript"><\/script>');
				break;

			case 'herev2':
				// already loaded
				break;

			case 'googlev3':
				// already loaded
				break;

			case 'leafletv0':
				document.write('<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" \/>');
				document.write('<!--[if lte IE 8]>');
			    document.write('<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" \/>');
			 	document.write('<![endif]-->');
				document.write('<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"><\/script>');
				break;

			case 'mapquestv7':
				document.write('<script src="http://www.mapquestapi.com/sdk/js/v7.0.s/mqa.toolkit.js?key=Fmjtd%7Cluub29uy25%2Crs%3Do5-96zl9y" type="text/javascript"><\/script>');
				break;
				
			case 'microsoftv7':
				document.write('<script charset="UTF-8" type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"><\/script>');
				document.write('<script type="text/javascript">');
				document.write('var microsoftv7_key = "AlneHdcKOFDot4FjwyuLH8ZSUIz5rv_X22vULKa7H5ia0JnsxiykdO8y-dgLQMU6";');
				document.write('<\/script>');
				break;


			case 'openlayersv2':
				document.write( '<script type="text/javascript" src="http://dev.openlayers.org/releases/OpenLayers-2.9.1/OpenLayers.js"><\/script>' );
				break;
				
			case 'openmapquestv7':
				document.write('<script src="http://open.mapquestapi.com/sdk/js/v7.0.s/mqa.toolkit.js"><\/script>');
				break;
				
			case 'openspacev4':
				document.write('<script type="text/javascript" src="http://openspace.ordnancesurvey.co.uk/osmapapi/openspace.js?key=CEEFBE51588492CBE0405F0ACA6010B1"><\/script>');
				break;

			case 'yandexv1':
				document.write('<script src="http://api-maps.yandex.ru/1.1/index.xml?key=AMVH-VABAAAAEdVkcQIAOS-fmBYJfLFV-YDg7ZCPjwVQycUAAAAAAAAAAADwTFcvgPirz7OV75IX_Gsopsw7jA==" type="text/javascript"><\/script >');
				break;

			case 'yandexv2':
				document.write('<script src="http://api-maps.yandex.ru/2.0/?load=package.full&lang=en-US" type="text/javascript" charset="utf-8"><\/script>');
				break;
				
			default:
				// already loaded
				break;
		}

		var providers = 'googlev3, herev2';
		if (provider != 'googlev3' && provider != 'herev2') {
			providers = provider + ',' + providers;
		}
		document.write('<script type="text/javascript" src="../source/mxn.js?(' + providers + ')"><\/script>');
	})();

	var events = {
		LOAD: {name: 'load', value: false},
		//CLICK: {name: 'click', value: false},
		END_PAN: {name: 'endPan', value: false},
		CHANGE_ZOOM: {name: 'changeZoom', value: false},
		MARKER_ADDED: {name: 'markerAdded', value: false},
		MARKER_INFOBUBBLE_OPENED: {name: 'InfoBubbleOpened', value: false}, 
		MARKER_INFOBUBBLE_CLOSED: {name: 'InfoBubbleClosed', value: false},
		MARKER_REMOVED: {name: 'markerRemoved', value: false},
		POLYLINE_ADDED: {name: 'polylineAdded', value: false},
		POLYLINE_REMOVED: {name: 'polylineRemoved', value: false}
	};
	
	function logInfo(msg) {
		logMessage ('info', msg);
	}
	
	function logEvent(msg) {
		logMessage ('events', msg);
	}

	function logMessage(element, msg) {
		var	display = document.getElementById(element);
		
		display.innerHTML += msg + '<br />';
		display.scrollTop = display.scrollHeight - display.clientHeight;
		return false;
	}
	
	function arrayContains(a, obj) {
	    var i = a.length;
	    while (i--) {
	       if (a[i] === obj) {
	           return true;
	       }
	    }
	    return false;
	}
	
	function arrayIndex(arr, obj) {
		var i = arr.length;
		while (i--) {
			if (arr[i] === obj) {
				return i
			}
		}
		
		return false;
	}
	
	var m;
	window.onload = function() {
		var actionElm = document.getElementById('actions');
		var infoElm = document.getElementById('info');		
		var eventsElm = document.getElementById('events');
		var providerElm = document.getElementById('provider');
		
		providerElm.innerHTML = provider;
		
		m = new mxn.Mapstraction('map', provider);

		// Ensure load event is handled before a subsequent call to setCenterAndZoom so
		// that the CloudMade load event fires correctly (it appears to trap the first
		// call to setCenter after map load, not the actual loading itself)

		m.load.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Map loaded for provider: ' + oEvtSource.api);
			events.LOAD.value = true;
		});

		// So far this is only necessary for leaflet.
		m.setCenterAndZoom(new mxn.LatLonPoint(37.4419, -122.1419), 10);

		m.endPan.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			var center = oEvtSource.getCenter();
			logEvent('Map pan: ' + Dump(center));
			events.END_PAN.value = true;
		});
		
		m.changeZoom.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			var zoom = oEvtSource.getZoom();
			logEvent('Change zoom: ' + zoom.toString());
			events.CHANGE_ZOOM.value = true;
		});
		
		m.markerAdded.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker added: ' + oEvtArgs.marker.labelText);
			events.MARKER_ADDED.value = true;
		});
		
		m.markerRemoved.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker removed: ' + oEvtArgs.marker.labelText);
			events.MARKER_REMOVED.value = true;
		});

		m.polylineAdded.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Polyline added');
			events.POLYLINE_ADDED.value = true;
		});

		m.polylineRemoved.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Polyline removed');
			events.POLYLINE_REMOVED.value = true;
		});

		m.click.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Map clicked: ' + Dump(oEvtArgs.location));
		});
		
		var markerEventHandler = function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker event: ' + sEvtName + ' - ' + oEvtSource.labelText);
			
			switch (sEvtName) {
				case 'openInfoBubble':
					events.MARKER_INFOBUBBLE_OPENED.value = true;
				break;
				case 'closeInfoBubble':
					events.MARKER_INFOBUBBLE_CLOSED.value = true;
				break;

				default:
					break;
			}
		};
				
		var ops = [
			{
				desc: 'Get API version',
				action: function() {
					var version = m.getVersion();
					logInfo('API Version "' + version + '" for "' + provider + '" loaded');
				}
			},
			{
				desc: 'Center map',
				action: function(){
					var point;
					var zoom;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(52.6959, 1.6846);
							zoom = 12;
							break;
						default:
							point = new mxn.LatLonPoint(37.4419, -122.1419);
							zoom = 9;
							break;
					}
					m.setCenterAndZoom(point, zoom);
				} 
			},		 
			{
				desc: 'Pan map',
				action: function(){
					var point;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(51.4269, -0.3339);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -122.0419);
							break;
					}
					
					m.setCenter(point, {pan: true});
				}
			},
			{
				desc: 'Get info',
				action: function(){
					logInfo('Info');
					var bb = m.getBounds();
					logInfo('Bounds:<br/>' + Dump(bb));
					var ll = m.getCenter();
					logInfo('Center: ' + Dump(ll));
					logInfo('Map type: ' + m.getMapType());
					logInfo('Zoom: ' + m.getZoom());
				}
			},
			{
				desc: 'Set zoom',
				action: function(){
					var zoom;
					switch (provider) {
						case 'openspacev4':
							zoom = 9;
							break;
						default:
							zoom = 8;
							break;
					}
					m.setZoom(zoom);
				}
			},
			{
				desc: 'Add marker',
				action: function() {
					var point;
					var mkr;
					var label;
					switch (provider) {
						case 'openspacev4':
							label = 'Twickenham Rugby Stadium';
							point = new mxn.LatLonPoint(51.45599, -0.34146);
							break;
							
						default:
							label = 'SFO International Terminal';
							point = new mxn.LatLonPoint(37.6156, -122.3891);
							break;
					}
					mkr = new mxn.Marker(point);
					mkr.setLabel(label);
					m.setCenter(point);
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Remove marker',
				action: function() {
					m.removeMarker(m.markers[0]);
				}
			},
			{
				desc: 'Add shape',
				action: function() {
					var shp;
					switch (provider) {
						case 'openspacev4':
						shp = new mxn.Polyline([
							new mxn.LatLonPoint(51.564, -0.534),
							new mxn.LatLonPoint(51.690, -0.231),
							new mxn.LatLonPoint(51.596, 0.040),
							new mxn.LatLonPoint(51.390, 0.191),
							new mxn.LatLonPoint(51.264, -0.131),
							new mxn.LatLonPoint(51.311, -0.429),
							new mxn.LatLonPoint(51.430, -0.533),
							new mxn.LatLonPoint(51.564, -0.534)
						]);
							break;
						default:
							shp = new mxn.Polyline([
								new mxn.LatLonPoint(37.805, -122.480),
								new mxn.LatLonPoint(37.678, -121.800),
								new mxn.LatLonPoint(37.238, -121.962),
								new mxn.LatLonPoint(37.462, -122.444),
								new mxn.LatLonPoint(37.805, -122.480)
							]);
							break;
					}
					shp.width = 3;
					shp.color = '#00DD55';
					shp.fillColor = '#0077FF';
					shp.opacity = 0.6;
					m.addPolyline(shp);
				}
			},
			{
				desc: 'Remove shape',
				action: function() {
					m.removePolyline(m.polylines[0]);
				}
			},
			{
				desc: 'Add marker',
				action: function(){
					var point;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(51.40995, -0.33627);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -122.0419);
							break;
					}
					var mkr = new mxn.Marker(point);
					mkr.setLabel('Some random place');
					mkr.setInfoBubble('Some information about the random place');
					mkr.click.addHandler(markerEventHandler);
					mkr.openInfoBubble.addHandler(markerEventHandler);
					mkr.closeInfoBubble.addHandler(markerEventHandler);
					m.setCenter(point);
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Show info bubble',
				action: function(){
					m.markers[0].openBubble();
				}
			},
			{
				desc: 'Hide info bubble',
				action: function(){
					m.markers[0].closeBubble();
				}
			},
			{
				desc: 'Add marker offscreen',
				action: function(){
					var marker;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(50.54157, -4.93825);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -117.0419);
							break;
					}
					var mkr = new mxn.Marker(point);
					mkr.setLabel('Some other place');
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Auto center',
				action: function(){
					m.autoCenterAndZoom();
				}
			},
			{
				desc: 'Hide one marker',
				action: function(){
					m.markers[0].hide();
				}
			},			
			{
				desc: 'Show one marker',
				action: function(){
					m.markers[0].show();
				}
			},			
			
			{
				desc: 'Add line',
				action: function(){
					var pl;
					switch (provider) {
						case 'openspacev4':
							pl = new mxn.Polyline([
								new mxn.LatLonPoint(51.40995, -0.33627),
								new mxn.LatLonPoint(51.4545, -2.5879),
								new mxn.LatLonPoint(50.72363, -3.53440),
								new mxn.LatLonPoint(50.54157, -4.93825)
							]);
							break;
						default:
							pl = new mxn.Polyline([
								new mxn.LatLonPoint(37.3419, -122.0419),
								new mxn.LatLonPoint(36.3419, -120.0419),
								new mxn.LatLonPoint(38.3419, -119.0419),
								new mxn.LatLonPoint(37.3419, -117.0419)
							]);
							break;
					}
					pl.color = '#00DD55';
					m.addPolyline(pl);
				}
			},
			{
				desc: 'Add 2nd Polyline',
				action: function() {
					var shp;
					switch (provider) {
						case 'openspacev4':
						shp = new mxn.Polyline([
							new mxn.LatLonPoint(51.564, -0.534),
							new mxn.LatLonPoint(51.690, -0.231),
							new mxn.LatLonPoint(51.596, 0.040),
							new mxn.LatLonPoint(51.390, 0.191),
							new mxn.LatLonPoint(51.264, -0.131),
							new mxn.LatLonPoint(51.311, -0.429),
							new mxn.LatLonPoint(51.430, -0.533)
						]);
							break;
						default:
							shp = new mxn.Polyline([
								new mxn.LatLonPoint(37.805, -122.480),
								new mxn.LatLonPoint(37.678, -121.800),
								new mxn.LatLonPoint(37.238, -121.962),
								new mxn.LatLonPoint(37.462, -122.444)
							]);
							break;
					}
					shp.width = 3;
					shp.color = '#0077FF';
					shp.opacity = 0.6;
					m.addPolyline(shp);
				}
			},			
			{
				desc: 'Hide one polyline',
				action: function(){
					m.polylines[0].hide();
				}
			},			
			{
				desc: 'Show one polyline',
				action: function(){
					m.polylines[0].show();
				}
			},
			{
				desc: 'Add All Controls',
				action: function() {
					m.addControls({
						pan:	 true,
						zoom:	 'large',
						overview: true,
						scale: true,
						map_type: true
					});
				}
			},
			{
				desc: 'Remove Controls',
				action: function() {
					m.addControls( { } );
				}
			},
			{
				desc: 'Add Small Controls',
				action: function() {
					m.addSmallControls();
				}
			},
			{
				desc: 'Add Large Controls',
				action: function() {
					m.addControls( { } );
					m.addLargeControls();
				}
			},
			{
				desc: 'Add Pan Controls',
				action: function() {
					m.addControls( { pan: true });
				}
			},
			{
				desc: 'Add Overview Controls',
				action: function() {
					m.addControls( { overview: true });
				}
			},
			{
				desc: 'Add Scale Controls',
				action: function() {
					m.addControls( { scale: true });
				}
			},
			{
				desc: 'Add Map Type Controls',
				action: function() {
					m.addControls( { });
					m.addMapTypeControls();
				}
			},
			/*
			{
				desc: 'Add Base map type',
				action: function() {
					m.addTileLayer("http://tile.openstreetmap.org/{Z}/{X}/{Y}.png", 1.0, "OSM", 1, 19, true);
					// m.setMapType("OSM");
				}
			},
			*/			
			{
				desc: 'Change type',
				action: function(){
					m.setMapType(mxn.Mapstraction.SATELLITE);
				}
			},
			{
				desc: 'Check events',
				action: function() {
					var evt;
					for (evt in events) {
						var props = events[evt];
						var check = true;
						
						if (props.hasOwnProperty('skip')) {
							var skip = props.skip.split(',');
							if (arrayContains(skip, provider)) {
								check = false;
							}
						}
						
						if (check) {
							if (props.value) {
								logInfo('Event: ' + props.name + ' passed');
							}
							else {
								infoElm.style.backgroundColor = '#FCC';
								logInfo('Event: ' + props.name + ' failed');
							}
						}
						
						else {
							logInfo ('Event: ' + props.name + ' skipped');
						}
					}
				}
			},
			
			{
				desc: 'Swap API',
				action: function(){
					if (provider == 'googlev3') {
						m.swap('map', 'herev2');
					}
					else {
						m.swap('map', 'googlev3');
					}
				}
			},
			
			{
				desc: 'Done.',
				action: function(){
					if (autoRun === 'true') {
						idx = arrayIndex(supportedProviders, provider);
						if (++idx < supportedProviders.length) {
							var nextProvider = supportedProviders[idx];
							var nextURL =  location.pathname + '?auto=true&provider=' + nextProvider;
							window.location = nextURL;
							return false;
						}
					}
				}
			}
		];
		
		RunTests(ops, actionElm, infoElm);
	
	};
		
	//]]>
	</script>
</head>
<body>
	<h1>Mapstraction Core Test For Provider "<span id="provider"></span>"</h1>
	<div id="wrapper">
		<div id="map"></div>
		<div>
			<h3>Providers</h3>
			<ul id="providers" >
				<li><a href="core.html?provider=esriv3">ESRI v3</a></li>
				<li><a href="core.html?provider=googlev3">Google v3</a></li>
				<li><a href="core.html?provider=herev2">HERE v2</a></li>
				<li><a href="core.html?provider=leafletv0">Leaflet</a></li>
				<li><a href="core.html?provider=mapquestv7">MapQuest v7</a></li>
				<li><a href="core.html?provider=microsoftv7">Microsoft v7</a></li>
				<li><a href="core.html?provider=openlayersv2">OpenLayers v2</a></li>
				<li><a href="core.html?provider=openmapquestv7">Open MapQuest v7</a></li>
				<li><a href="core.html?provider=openspacev4">OS OpenSpace v4</a></li>
				<li><a href="core.html?provider=yandexv1">Yandex v1</a></li>
				<li><a href="core.html?provider=yandexv2">Yandex v2</a></li>
			</ul>
		</div>
		<div id="box-wrapper">
			<div class="box">
				<h2>Actions</h2>
				<div id="container">
					<ol id="actions"></ol>
				</div>
			</div>
			<div class="box">
				<h2>Info</h2>
				<div id="info"></div>
			</div>
			<div class="box">
				<h2>Events</h2>
				<div id="events"></div>
			</div>
		</div>
		<p id="provider-selection">
			<a href="core.html?provider=esriv3&auto=true">Auto-run all provider core tests</a> or run with provider: <a href="?provider=esriv3">esriv3</a>,
			<a href="?provider=googlev3">googlev3</a>,
			<a href="?provider=herev2">herev2</a>,
			<a href="?provider=leafletv0">leafletv0</a>,
			<a href="?provider=mapquestv7">mapquestv7</a>,
			<a href="?provider=microsoftv7">microsoftv7</a>,
			<a href="?provider=openlayersv2">openlayersv2</a>,
			<a href="?provider=openmapquestv7">openmqv7</a>,
			<a href="?provider=openspacev4">openspacev4</a>,
			<a href="?provider=yandexv1">yandexv1</a>,
			<a href="?provider=yandexv2">yandexv2</a>.
		</p>
	</div>
</body>
</html>

